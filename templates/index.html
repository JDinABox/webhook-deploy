<!DOCTYPE html>
<html>
  <head>
    <title>Web Interface</title>
    <link href="./assets/output.css" rel="stylesheet" />
  </head>
  <body class="flex h-screen min-w-full bg-zinc-900 text-white">
    <div class="max-w-5xl mx-auto grow flex flex-col">
      <div class="flex justify-between items-center mt-4">
        <h1 class="text-2xl font-bold">Github Webhook Deploy</h1>

        {{ if ne .Username "" }}
        <div>
          Welcome, {{ .Username }}!
          <button
            onclick="logout()"
            class="px-2 py-1 bg-red-900 hover:bg-red-700 rounded-md cursor-pointer"
          >
            Logout
          </button>
        </div>
        {{ end }}
      </div>

      <div class="p-4 mt-4 flex flex-col bg-zinc-800 rounded-md">
        <h2 class="text-xl font-bold">Deployment Controls</h2>
        <div class="flex mt-3">
          <select
            id="deploymentSelector"
            class="mr-2 border-1 border-neutral-500 bg-zinc-900 rounded-md px-2 py-1"
          >
            {{ range $repoName, $deployment := .Deployments }}
            <option value="{{ $repoName }}">{{ $repoName }}</option>
            {{ end }}
          </select>
          <button
            onclick="runDeployment()"
            class="px-2 py-1 bg-blue-900 hover:bg-blue-700 rounded-md cursor-pointer"
          >
            Run Selected Deployment
          </button>
        </div>
      </div>

      <div class="my-4 flex flex-col grow p-4 bg-zinc-800 rounded-md min-h-0">
        <h2 class="text-xl font-bold">
          Request Logs
          <button
            onclick="location.reload()"
            class="ml-2 inline-block align-middle text-zinc-400 hover:text-white focus:outline-none"
          >
            <!-- Icon Licensed under the MIT License (https://github.com/radix-ui/icons/blob/master/LICENSE). Copyright (c) 2022 WorkOS-->
            <svg
              width="15"
              height="15"
              viewBox="0 0 15 15"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                d="M1.84998 7.49998C1.84998 4.66458 4.05979 1.84998 7.49998 1.84998C10.2783 1.84998 11.6515 3.9064 12.2367 5H10.5C10.2239 5 10 5.22386 10 5.5C10 5.77614 10.2239 6 10.5 6H13.5C13.7761 6 14 5.77614 14 5.5V2.5C14 2.22386 13.7761 2 13.5 2C13.2239 2 13 2.22386 13 2.5V4.31318C12.2955 3.07126 10.6659 0.849976 7.49998 0.849976C3.43716 0.849976 0.849976 4.18537 0.849976 7.49998C0.849976 10.8146 3.43716 14.15 7.49998 14.15C9.44382 14.15 11.0622 13.3808 12.2145 12.2084C12.8315 11.5806 13.3133 10.839 13.6418 10.0407C13.7469 9.78536 13.6251 9.49315 13.3698 9.38806C13.1144 9.28296 12.8222 9.40478 12.7171 9.66014C12.4363 10.3425 12.0251 10.9745 11.5013 11.5074C10.5295 12.4963 9.16504 13.15 7.49998 13.15C4.05979 13.15 1.84998 10.3354 1.84998 7.49998Z"
                fill="currentColor"
                fill-rule="evenodd"
                clip-rule="evenodd"
                data-darkreader-inline-fill=""
                style="--darkreader-inline-fill: currentColor"
              ></path>
            </svg>
          </button>
        </h2>
        <div
          class="p-3 grow bg-neutral-900 rounded-md flex flex-col mt-3 overflow-auto"
        >
          {{ range .Logs }}
          <div>{{ . }}</div>
          {{ else }} No logs available. {{ end }}
        </div>
      </div>
    </div>

    <script>
      async function runDeployment() {
        const selector = document.getElementById("deploymentSelector");
        const repoName = selector.value;
        if (!repoName) {
          alert("Please select a deployment target.");
          return;
        }

        if (confirm(`Are you sure you want to deploy ${repoName}?`)) {
          console.log(`Attempting to deploy: ${repoName}`);
          const response = await fetch("/deploy", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ repository: repoName }),
          });
          const text = await response.text();
          alert(text);
          location.reload();
        }
      }

      async function logout() {
        const response = await fetch("/logout", {
          method: "POST",
        });
        if (response.ok) {
          alert("Logged out successfully.");
          location.reload();
        } else {
          alert("Logout failed.");
        }
      }
    </script>
  </body>
</html>
